<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WR Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#0b1220;
        --text:#e5e7eb;
        --surface:rgba(255,255,255,0.06);
        --border:rgba(255,255,255,0.14);
        --muted:rgba(255,255,255,0.55);
        --btn-surface:rgba(255,255,255,0.15);
        --bubble-user-bg:rgba(34,197,94,0.12);
        --bubble-user-border:rgba(34,197,94,0.45);
        --bubble-assist-bg:rgba(255,255,255,0.10);
        --bubble-assist-border:rgba(255,255,255,0.20);
      }
      .theme-default{
        /* Purple gradient like extension default - stronger gradient */
        --bg-grad: linear-gradient(135deg, #c084fc 0%, #a855f7 50%, #9333ea 100%);
        --bg:#1e1b4b; /* fallback under gradient */
        --text:#ffffff;
        --surface: rgba(118,75,162,0.25);
        --border: rgba(255,255,255,0.20);
        --muted: rgba(255,255,255,0.85);
        --btn-surface: rgba(118,75,162,0.35);
        --bubble-user-bg: rgba(34,197,94,0.14);
        --bubble-user-border: rgba(34,197,94,0.55);
        --bubble-assist-bg: rgba(118,75,162,0.20);
        --bubble-assist-border: rgba(255,255,255,0.22);
      }
      .theme-professional{
        --bg:#f8fafc;
        --text:#0f172a;
        --surface:#ffffff;
        --border:#e2e8f0;
        --muted:#475569;
        --btn-surface:#e2e8f0;
        --bubble-user-bg:#e6f7ee;
        --bubble-user-border:#a7f3d0;
        --bubble-assist-bg:#f1f5f9;
        --bubble-assist-border:#e2e8f0;
        --bg-grad: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      }
      .theme-dark{
        --bg:#0b1220;
        --text:#e5e7eb;
        --surface:rgba(255,255,255,0.06);
        --border:rgba(255,255,255,0.14);
        --muted:rgba(255,255,255,0.55);
        --btn-surface:rgba(255,255,255,0.15);
        --bubble-user-bg:rgba(34,197,94,0.12);
        --bubble-user-border:rgba(34,197,94,0.45);
        --bubble-assist-bg:rgba(255,255,255,0.10);
        --bubble-assist-border:rgba(255,255,255,0.20);
        --bg-grad: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      }

      html, body { height: 100%; margin: 0; font-family: -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
      /* Remove default user agent titlebar tint (Windows) by ensuring no page-level accent conflicts */
      body { accent-color: initial; }
      body.theme-default { background: var(--bg-grad); }
      body.theme-professional { background: var(--bg-grad); }
      body.theme-dark { background: var(--bg-grad); }
      .wrap { display: flex; flex-direction: column; height: 100%; }
      /* remove in-page header to maximize space */
      .messages { flex: 1; overflow: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
      .row { display: flex; }
      .row.user { justify-content: flex-end; }
      .bubble { max-width: 78%; padding: 10px 12px; border-radius: 10px; font-size: 12px; line-height: 1.45; }
      .bubble.user { background: var(--bubble-user-bg); border: 1px solid var(--bubble-user-border); }
      .bubble.assistant { background: var(--bubble-assist-bg); border: 1px solid var(--bubble-assist-border); }
      .toolkit { display:flex; gap:10px; align-items:center; padding:12px 16px; border-bottom:none; background: transparent; }
      .tk-btn { height:28px; padding:0 8px; border-radius:6px; border:1px solid var(--border); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:12px; background: var(--surface); color:var(--text); }
      .tk-bucket { color:#ef4444; }
      .composer { display: grid; grid-template-columns: 1fr 40px 40px auto; gap: 8px; padding: 8px 12px 12px; align-items: center; border-top:1px solid var(--border); }
      .ta { box-sizing: border-box; width: 100%; height: 42px; max-height: 180px; resize: vertical; background: var(--surface); border:1px solid var(--border); color:var(--text); padding:10px; border-radius:8px; font-size:12px; }
      .btn { height: 42px; background: var(--btn-surface); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0 12px; cursor: pointer; display:flex; align-items:center; justify-content:center; }
      .btn:disabled { opacity: .5; cursor: default; }
      .bucket { border-color:#ef4444; color:#ef4444; background: var(--surface); }
      
      /* Send button with model selector */
      .send-wrapper { position:relative; display:flex; margin-right:2px; }
      /* Always green button */
      .send-main { 
        height:44px; padding:4px 14px; 
        background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
        border:1px solid #15803d; border-right:none; 
        border-radius:10px 0 0 10px; 
        color:#052e16; cursor:pointer; 
        display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1px;
        box-shadow:0 2px 4px rgba(0,0,0,0.1);
        transition:all 0.2s ease;
      }
      .send-main:disabled { box-shadow:none; cursor:not-allowed; opacity:0.7; }
      .send-main:not(:disabled):hover { transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
      .send-main .send-text { font-size:13px; font-weight:700; line-height:1; }
      .send-main .send-model { font-size:9px; opacity:0.85; line-height:1; max-width:70px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      
      /* Loading state - purple */
      .send-main.loading { background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-color:#7c3aed; color:#ffffff; }
      .send-main.loading + .send-dropdown-btn { background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-color:#7c3aed; color:#ffffff; }
      
      .send-dropdown-btn { 
        height:44px; width:22px; 
        background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
        border:1px solid #15803d; border-left:1px solid rgba(255,255,255,0.2); 
        border-radius:0 10px 10px 0; 
        color:#052e16; font-size:10px; cursor:pointer; 
        display:flex; align-items:center; justify-content:center;
        box-shadow:0 2px 4px rgba(0,0,0,0.1);
        transition:all 0.2s ease;
      }
      .send-dropdown-btn:disabled { box-shadow:none; cursor:not-allowed; opacity:0.7; }
      .send-dropdown-btn:not(:disabled):hover { opacity:0.85; transform:translateY(-1px); }
      .send-dropdown { position:absolute; bottom:100%; right:0; margin-bottom:6px; background:var(--surface); border:1px solid var(--border); border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.25); z-index:1000; min-width:180px; max-height:220px; overflow-y:auto; display:none; }
      .send-dropdown.open { display:block; }
      .send-dropdown-header { padding:8px 12px; font-size:10px; font-weight:700; opacity:0.5; border-bottom:1px solid var(--border); letter-spacing:0.5px; }
      .send-dropdown-item { padding:10px 12px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:8px; border-left:3px solid transparent; transition:all 0.15s ease; }
      .send-dropdown-item:hover { background:rgba(255,255,255,0.08); border-left-color:#22c55e; }
      .send-dropdown-item.active { background:rgba(34,197,94,0.25); border-left-color:#22c55e; font-weight:600; }
      .send-dropdown-item .check { width:16px; color:#22c55e; font-weight:700; }
      .send-dropdown-item .name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .send-dropdown-item .size { font-size:10px; opacity:0.5; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; }
      body.theme-professional .send-main:disabled { background:linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); border-color:#94a3b8; color:#64748b; }
      body.theme-professional .send-dropdown { background:#ffffff; border-color:#e2e8f0; }
      body.theme-professional .send-dropdown-item:hover { background:#f1f5f9; }
      body.theme-professional .send-dropdown-item.active { background:rgba(34,197,94,0.12); }
      body.theme-professional .send-dropdown-item { color:#0f172a; }
      body.theme-professional .send-dropdown-item .size { background:#e2e8f0; }
      
      /* Mode selector styling - Pill style */
      .mode-select { font-size:12px; font-weight:500; background:rgba(55,65,81,0.9); border:none; color:#ffffff; border-radius:14px; padding:8px 24px 8px 12px; cursor:pointer; outline:none; appearance:none; -webkit-appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 12 12'%3E%3Cpath fill='rgba(255,255,255,0.7)' d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; transition: all 0.15s ease; }
      .mode-select:hover { background:rgba(55,65,81,1); }
      body.theme-professional .mode-select { background:rgba(55,65,81,0.9); color:#ffffff; }
      body.theme-professional .mode-select:hover { background:rgba(55,65,81,1); }
      body.theme-dark .mode-select { background:rgba(55,65,81,0.9); }
      
      /* Chat view styles */
      .chat-view { display:flex; flex-direction:column; flex:1; }
      .chat-view.hidden { display:none; }
      
      /* Augmented Overlay styles */
      .overlay-view { display:none; flex-direction:column; flex:1; }
      .overlay-view.active { display:flex; }
      .overlay-hint { padding:16px; font-size:13px; opacity:0.9; font-style:italic; background:rgba(59,130,246,0.12); display:flex; align-items:flex-start; gap:12px; line-height:1.6; border-radius:8px; margin:12px; }
      .overlay-hint-icon { font-size:24px; flex-shrink:0; }
      
      /* Code Executor styles */
      .code-executor-view { display:none; flex-direction:column; flex:1; }
      .code-executor-view.active { display:flex; }
      .code-hint { padding:14px; font-size:12px; background:rgba(34,197,94,0.12); display:flex; align-items:flex-start; gap:12px; line-height:1.5; border-radius:8px; margin:12px; border:1px solid rgba(34,197,94,0.25); }
      .code-hint-icon { font-size:24px; flex-shrink:0; }
      .code-hint-content { flex:1; }
      .code-result { margin:0 12px 12px; background:var(--surface); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
      .code-result-header { display:flex; align-items:center; gap:8px; padding:10px 12px; background:rgba(0,0,0,0.2); border-bottom:1px solid var(--border); font-size:11px; }
      .code-result-status { font-weight:600; }
      .code-result-status.success { color:#22c55e; }
      .code-result-status.error { color:#ef4444; }
      .code-result-lang { background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase; }
      .code-result-btn { background:var(--btn-surface); border:1px solid var(--border); color:var(--text); padding:4px 10px; border-radius:4px; font-size:10px; cursor:pointer; margin-left:auto; }
      .code-result-btn:hover { background:rgba(255,255,255,0.15); }
      .code-result-btn-primary { background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-color:#15803d; color:#052e16; }
      .code-result-btn-primary:hover { opacity:0.9; }
      .code-result-output { margin:0; padding:12px; font-size:12px; font-family:'Consolas', 'Monaco', monospace; white-space:pre-wrap; word-break:break-word; max-height:200px; overflow:auto; background:rgba(0,0,0,0.15); color:var(--text); }
      .code-send-btn { background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important; border-color:#7c3aed !important; color:#ffffff !important; }
      .code-send-btn:hover { opacity:0.9; }
      
      /* MailGuard styles */
      .mailguard-view { display:none; flex-direction:column; flex:1; }
      .mailguard-view.active { display:flex; }
      .mg-hint { padding:14px; font-size:13px; opacity:0.85; font-style:italic; border-bottom:1px solid var(--border); background:rgba(168,85,247,0.12); display:flex; align-items:center; gap:10px; }
      .mg-hint-icon { font-size:18px; }
      .mg-fields { padding:14px; display:flex; flex-direction:column; gap:12px; flex:1; overflow:auto; }
      .mg-row { display:flex; align-items:center; gap:10px; }
      .mg-label { font-size:13px; font-weight:600; opacity:0.85; min-width:60px; color:var(--text); }
      .mg-input { flex:1; background:var(--surface); border:1px solid var(--border); color:var(--text); border-radius:6px; padding:10px 12px; font-size:14px; outline:none; }
      .mg-input::placeholder { color:var(--muted); opacity:0.7; }
      body.theme-professional .mg-input::placeholder { color:#64748b; opacity:0.8; }
      body.theme-dark .mg-input::placeholder { color:rgba(255,255,255,0.5); }
      body.theme-default .mg-input::placeholder { color:rgba(255,255,255,0.6); }
      .mg-body { flex:1; min-height:150px; background:var(--surface); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:12px 14px; font-size:14px; line-height:1.6; resize:none; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; outline:none; }
      .mg-body::placeholder { color:var(--muted); opacity:0.7; }
      body.theme-professional .mg-body::placeholder { color:#64748b; opacity:0.8; }
      body.theme-dark .mg-body::placeholder { color:rgba(255,255,255,0.5); }
      body.theme-default .mg-body::placeholder { color:rgba(255,255,255,0.6); }
      .mg-attach-row { display:flex; align-items:center; justify-content:space-between; margin-top:4px; }
      .mg-attach-label { font-size:12px; font-weight:600; opacity:0.75; display:flex; align-items:center; gap:6px; }
      .mg-attach-note { font-size:10px; opacity:0.6; font-weight:400; }
      .mg-add-btn { background:var(--btn-surface); border:1px solid var(--border); color:var(--text); border-radius:6px; padding:8px 14px; font-size:12px; font-weight:500; cursor:pointer; }
      .mg-attachments { display:flex; flex-wrap:wrap; gap:8px; padding:8px 0; }
      .mg-att-chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:rgba(34,197,94,0.12); border:1px solid rgba(34,197,94,0.35); border-radius:6px; font-size:12px; }
      .mg-att-name { max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .mg-att-size { opacity:0.5; font-size:11px; }
      .mg-att-remove { background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:0 2px; opacity:0.7; }
      .mg-att-remove:hover { opacity:1; color:#ef4444; }
      .mg-footer { padding:12px 14px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--surface); }
      .mg-discard { background:transparent; border:none; color:var(--muted); padding:8px 12px; font-size:13px; cursor:pointer; text-decoration:underline; text-underline-offset:2px; }
      .mg-send { background:#a855f7; border:none; color:white; border-radius:8px; padding:12px 24px; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; box-shadow:0 2px 8px rgba(168,85,247,0.4); }
      .mg-send:disabled { background:#6b7280; box-shadow:none; cursor:not-allowed; opacity:0.7; }
      .mg-send:not(:disabled):hover { background:#9333ea; }
    </style>
  </head>
  <body>
      <div class="wrap">
      <div class="toolkit">
        <div style="display:flex; gap:6px; align-items:center;">
          <select id="workspace-select" class="mode-select" style="width:95px; font-size:11px; padding:6px 20px 6px 8px; text-overflow:ellipsis;">
            <option value="wr-chat">üí¨ WR Chat</option>
            <option value="augmented-overlay">üéØ Augmented Overlay</option>
            <option value="mailguard">üõ°Ô∏è WR MailGuard</option>
          </select>
          <select id="submode-select" class="mode-select" style="width:100px; background:rgba(55,65,81,0.85) !important; font-size:11px; padding:6px 18px 6px 6px; text-overflow:ellipsis;">
            <option value="command">cmd</option>
            <option value="p2p-chat">Direct Chat</option>
            <option value="p2p-stream">Live Views</option>
            <option value="group-stream">Group Sessions</option>
            <option value="handshake">Handshake Request</option>
          </select>
        </div>
        <div id="chat-controls" style="display:flex; gap:8px; align-items:center;">
          <button id="tk-pencil" class="tk-btn" title="LmGTFY - Capture a screen area as screenshot or stream and send it to your pre-defined automation tasks.">‚úé</button>
          <div id="tk-tags-wrapper" style="position:relative;">
            <button id="tk-tags" class="tk-btn" title="Saved Tagged Triggers" style="padding-right:18px;">‚ñæ Tags</button>
            <div id="tk-tags-dropdown" style="display:none;position:absolute;top:100%;left:0;min-width:200px;max-height:300px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;"></div>
          </div>
        </div>
      </div>
      
      <!-- Command Chat View -->
      <div id="chat-view" class="chat-view">
        <div id="msgs" class="messages"></div>
        <div class="composer" id="composer">
          <textarea id="ta" class="ta" placeholder="Type a command for the Orchestrator..."></textarea>
          <input id="file" type="file" multiple style="display:none" />
          <button id="up" class="btn" title="Attach">üìé</button>
          <button id="mic" class="btn" title="Voice input">üéôÔ∏è</button>
          <div class="send-wrapper">
            <button id="send" class="send-main" title="Send message">
              <span class="send-text">Send</span>
              <span id="model-label" class="send-model">No model</span>
            </button>
            <button id="send-dropdown-btn" class="send-dropdown-btn" title="Select model">‚ñæ</button>
            <div id="send-dropdown" class="send-dropdown">
              <div class="send-dropdown-header">SELECT MODEL</div>
              <div id="model-list"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- P2P Chat View -->
      <div id="p2p-chat-view" class="chat-view" style="display:none;">
        <div style="padding:8px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.1);">
          <div style="display:flex; align-items:center; gap:8px;">
            <div style="width:8px; height:8px; border-radius:50%; background:#6b7280;"></div>
            <span style="font-size:12px; color:var(--muted);">No peer connected</span>
          </div>
          <button class="tk-btn" style="font-size:10px; padding:4px 8px;">Connect</button>
        </div>
        <div id="p2p-msgs" class="messages"></div>
        <div class="composer">
          <textarea id="p2p-ta" class="ta" placeholder="Message or capsule..."></textarea>
          <button id="p2p-capsule" class="btn" title="Build Capsule">üíä</button>
          <button id="p2p-ai" class="btn" title="AI Assistant">‚ú®</button>
          <button id="p2p-up" class="btn" title="Attach">üìé</button>
          <button class="send-main" style="padding:0 14px;">Send</button>
        </div>
      </div>

      <!-- P2P Stream View -->
      <div id="p2p-stream-view" style="display:none; flex:1; flex-direction:column;">
        <div style="flex:2; background:#000; display:flex; align-items:center; justify-content:center; position:relative;">
          <div style="text-align:center; color:#666;">
            <div style="font-size:40px; margin-bottom:8px;">üìπ</div>
            <div style="font-size:12px;">No active stream</div>
          </div>
          <div style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:8px;">
            <button class="tk-btn" style="background:rgba(255,255,255,0.1);">üé• Start</button>
            <button class="tk-btn" style="background:rgba(255,255,255,0.1);">üéôÔ∏è Mute</button>
            <button class="tk-btn" style="background:rgba(255,255,255,0.1);">üì∫ Share</button>
          </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; min-height:150px;">
          <div class="messages" style="flex:1; padding:8px;"></div>
          <div class="composer" style="padding:8px;">
            <textarea class="ta" placeholder="Chat..." style="min-height:28px;"></textarea>
            <button id="stream-ai" class="btn" title="AI Assistant">‚ú®</button>
            <button class="send-main" style="padding:0 10px; font-size:11px;">Send</button>
          </div>
        </div>
      </div>

      <!-- Group Stream View -->
      <div id="group-stream-view" style="display:none; flex:1; flex-direction:column;">
        <div style="flex:2; display:flex; background:#000;">
          <div style="flex:1; display:flex; align-items:center; justify-content:center; border-right:1px solid #333;">
            <div style="text-align:center; color:#666;">
              <div style="font-size:32px;">üë§</div>
              <div style="font-size:10px; margin-top:4px;">Host</div>
            </div>
          </div>
          <div style="width:80px; display:flex; flex-direction:column; gap:2px; padding:4px; overflow-y:auto;">
            <div style="aspect-ratio:1; background:#111; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#444; font-size:14px;">üë§</div>
            <div style="aspect-ratio:1; background:#111; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#444; font-size:14px;">+</div>
          </div>
        </div>
        <div style="padding:6px 10px; border-top:1px solid var(--border); border-bottom:1px solid var(--border); display:flex; gap:6px; justify-content:center;">
          <button class="tk-btn" style="font-size:10px;">üé•</button>
          <button class="tk-btn" style="font-size:10px;">üéôÔ∏è</button>
          <button class="tk-btn" style="font-size:10px;">üì∫</button>
          <button class="tk-btn" style="font-size:10px; background:rgba(239,68,68,0.2); color:#ef4444;">Leave</button>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; min-height:120px;">
          <div class="messages" style="flex:1; padding:8px;"></div>
          <div class="composer" style="padding:8px;">
            <textarea class="ta" placeholder="Group chat..." style="min-height:28px;"></textarea>
            <button id="group-ai" class="btn" title="AI Assistant">‚ú®</button>
            <button class="send-main" style="padding:0 10px; font-size:11px;">Send</button>
          </div>
        </div>
      </div>

      <!-- Handshake Request View -->
      <div id="handshake-view" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
        <div style="padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px;">
          <span style="font-size:18px;">ü§ù</span>
          <span style="font-size:13px; font-weight:600;">BEAP‚Ñ¢ Handshake Request</span>
        </div>
        
        <div style="flex:1; padding:14px; overflow-y:auto; display:flex; flex-direction:column; gap:12px;">
          <!-- Fingerprint Section -->
          <div id="hs-fingerprint-section" style="padding:12px 14px; background:rgba(139,92,246,0.15); border:2px solid rgba(139,92,246,0.3); border-radius:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
              <div style="font-size:11px; font-weight:600; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:0.5px; display:flex; align-items:center; gap:6px;">
                üîê Your Fingerprint
                <span style="cursor:help; font-size:11px; font-weight:400;" title="A fingerprint is a short identifier derived from the handshake identity. It helps prevent mix-ups and look-alike contacts. It is not a secret key.">‚ìò</span>
              </div>
              <button id="hs-copy-fp" style="padding:4px 10px; font-size:10px; background:rgba(255,255,255,0.1); border:none; border-radius:4px; color:rgba(255,255,255,0.7); cursor:pointer;">üìã Copy</button>
            </div>
            <div id="hs-fingerprint-full" style="font-family:monospace; font-size:11px; color:white; word-break:break-all; line-height:1.5;"></div>
            <div style="margin-top:8px; font-size:10px; color:rgba(255,255,255,0.5);">
              Short: <span id="hs-fingerprint-short" style="font-family:monospace;"></span>
            </div>
          </div>
          
          <!-- Delivery Method -->
          <div>
            <label style="font-size:11px; font-weight:600; margin-bottom:6px; display:block; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:0.5px;">Delivery Method</label>
            <select id="hs-delivery" style="width:100%; padding:10px 12px; background:#1f2937; border:1px solid rgba(255,255,255,0.15); border-radius:8px; color:white; font-size:13px; cursor:pointer;">
              <option value="email">üìß Email</option>
              <option value="messenger">üí¨ Messenger (Web)</option>
              <option value="download">üíæ Download (USB/Wallet)</option>
            </select>
          </div>
          
          <!-- To & Subject Fields - Only for Email -->
          <div id="hs-email-fields" style="display:flex; flex-direction:column; gap:12px;">
            <div>
              <label style="font-size:11px; font-weight:600; margin-bottom:6px; display:block; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:0.5px;">To:</label>
              <input type="email" id="hs-to" placeholder="recipient@example.com" style="width:100%; padding:10px 12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; color:white; font-size:13px; box-sizing:border-box;" />
            </div>
            <div>
              <label style="font-size:11px; font-weight:600; margin-bottom:6px; display:block; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:0.5px;">Subject:</label>
              <input type="text" id="hs-subject" value="Request to Establish BEAP‚Ñ¢ Secure Communication Handshake" style="width:100%; padding:10px 12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; color:white; font-size:13px; box-sizing:border-box;" />
            </div>
          </div>
          
          <!-- Message -->
          <div style="flex:1; display:flex; flex-direction:column;">
            <label style="font-size:11px; font-weight:600; margin-bottom:6px; display:block; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:0.5px;">Message</label>
            <textarea id="hs-message" style="flex:1; min-height:180px; padding:10px 12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; color:white; font-size:13px; line-height:1.5; resize:none; box-sizing:border-box;"></textarea>
          </div>
          
          <!-- Info -->
          <div style="padding:10px 12px; background:rgba(139,92,246,0.15); border-radius:8px; font-size:11px; color:rgba(255,255,255,0.8); display:flex; flex-direction:column; gap:6px;">
            <div>üí° This creates a secure BEAP‚Ñ¢ package. Recipient will appear in your Handshakes once accepted.</div>
            <div style="opacity:0.8; font-size:10px;">‚ÑπÔ∏è Local Receiver Policy overrides package policy.</div>
          </div>
        </div>
        
        <!-- Footer -->
        <div style="padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end;">
          <button id="hs-cancel" style="padding:8px 16px; background:transparent; border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; font-size:12px; cursor:pointer;">Cancel</button>
          <button id="hs-send" style="padding:8px 20px; background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border:none; border-radius:8px; color:white; font-size:12px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
            <span id="hs-send-icon">üìß</span> <span id="hs-send-text">Send</span>
          </button>
        </div>
      </div>

      <!-- Augmented Overlay View -->
      <div id="overlay-view" class="overlay-view">
        <div id="overlay-msgs" class="messages">
          <div class="overlay-hint">
            <span class="overlay-hint-icon">üéØ</span>
            <span>Point with the cursor or select elements in order to ask questions or trigger automations directly in the UI.</span>
          </div>
        </div>
        <div class="composer">
          <textarea id="overlay-ta" class="ta" placeholder="Ask about the selected element..."></textarea>
          <input id="overlay-file" type="file" multiple style="display:none" />
          <button id="overlay-up" class="btn" title="Attach">üìé</button>
          <button id="overlay-mic" class="btn" title="Voice input">üéôÔ∏è</button>
          <div class="send-wrapper">
            <button id="overlay-send" class="send-main" title="Send message">
              <span class="send-text">Send</span>
              <span class="send-model">auto</span>
            </button>
            <button class="send-dropdown-btn" title="Select model">‚ñæ</button>
          </div>
        </div>
      </div>
      
      <!-- Code Executor View -->
      <div id="code-executor-view" class="code-executor-view">
        <div id="code-executor-msgs" class="messages">
          <div class="code-hint">
            <span class="code-hint-icon">üöÄ</span>
            <div class="code-hint-content">
              <strong>Code Executor Mode</strong><br/>
              Ask AI to generate and run code for you. Examples:<br/>
              ‚Ä¢ "Print odd numbers from 1 to 10"<br/>
              ‚Ä¢ "Create a calculator app"<br/>
              ‚Ä¢ "Generate fibonacci sequence in JavaScript"
            </div>
          </div>
        </div>
        <div id="code-result" class="code-result" style="display:none;">
          <div class="code-result-header">
            <span id="code-result-status">‚úì Executed</span>
            <span id="code-result-lang" class="code-result-lang">python</span>
            <button id="code-result-open" class="code-result-btn" title="Open file" style="display:none;">üìÇ Open</button>
            <button id="code-result-miniapp" class="code-result-btn code-result-btn-primary" title="Open Mini App" style="display:none;">üöÄ Open App</button>
          </div>
          <pre id="code-result-output" class="code-result-output"></pre>
        </div>
        <div class="composer">
          <textarea id="code-ta" class="ta" placeholder="Describe what code you want to generate and run..."></textarea>
          <div class="send-wrapper">
            <button id="code-send" class="send-main code-send-btn" title="Generate & Execute">
              <span class="send-text">Generate & Run</span>
              <span id="code-model-label" class="send-model">No model</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- MailGuard View -->
      <div id="mailguard-view" class="mailguard-view">
        <!-- Email Accounts Section -->
        <div id="mg-accounts" class="mg-accounts" style="padding:14px; border-bottom:1px solid var(--border);">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:16px;">üîó</span>
              <span style="font-size:13px; font-weight:600;">Connected Email Accounts</span>
            </div>
            <button id="mg-connect-email" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border:none; color:white; border-radius:6px; padding:6px 12px; font-size:11px; font-weight:600; cursor:pointer;">+ Connect Email</button>
          </div>
          <div id="mg-accounts-list" style="min-height:50px;">
            <div id="mg-accounts-loading" style="padding:12px; text-align:center; opacity:0.6; font-size:12px; display:none;">Loading accounts...</div>
            <div id="mg-accounts-empty" style="padding:20px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px dashed rgba(255,255,255,0.2); text-align:center;">
              <div style="font-size:24px; margin-bottom:8px;">üìß</div>
              <div style="font-size:13px; opacity:0.7; margin-bottom:4px;">No email accounts connected</div>
              <div style="font-size:11px; opacity:0.5;">Connect your Gmail to view emails securely in MailGuard</div>
            </div>
            <div id="mg-accounts-content" style="display:none; flex-direction:column; gap:8px;"></div>
          </div>
          <div id="mg-accounts-active" style="display:none; margin-top:12px; padding:10px 12px; background:rgba(34,197,94,0.15); border-radius:6px; border:1px solid rgba(34,197,94,0.2); align-items:flex-start; gap:8px;">
            <span style="font-size:14px;">üõ°Ô∏è</span>
            <div style="font-size:11px; opacity:0.8; line-height:1.5;"><strong>MailGuard Active:</strong> When you visit Gmail, full email content will be fetched securely via the API.</div>
          </div>
        </div>
        
        <!-- Email Setup Wizard Modal -->
        <div id="mg-email-wizard" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
          <div style="width:360px; max-height:90vh; overflow-y:auto; background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius:12px; border:1px solid rgba(255,255,255,0.15); overflow:hidden;">
            <div style="padding:16px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:20px;">üìß</span>
                <span style="font-weight:600; color:white;">Connect Your Email</span>
              </div>
              <button id="mg-wizard-close" style="background:rgba(255,255,255,0.2); border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:14px;">√ó</button>
            </div>
            
            <!-- Provider Selection Step -->
            <div id="mg-wizard-provider" style="padding:16px;">
              <!-- Gmail OAuth -->
              <button id="mg-connect-gmail" style="width:100%; padding:12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px; margin-bottom:8px; color:white;">
                <span style="font-size:20px;">üìß</span>
                <div style="text-align:left; flex:1;">
                  <div style="font-weight:600;">Gmail</div>
                  <div style="font-size:11px; opacity:0.6;">Connect via Google OAuth</div>
                </div>
                <span style="opacity:0.4;">‚Üí</span>
              </button>
              
              <!-- Outlook OAuth -->
              <button id="mg-connect-outlook" style="width:100%; padding:12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px; margin-bottom:8px; color:white;">
                <span style="font-size:20px;">üì®</span>
                <div style="text-align:left; flex:1;">
                  <div style="font-weight:600;">Microsoft 365 / Outlook</div>
                  <div style="font-size:11px; opacity:0.6;">Connect via Microsoft OAuth</div>
                </div>
                <span style="opacity:0.4;">‚Üí</span>
              </button>
              
              <!-- IMAP / Other -->
              <button id="mg-connect-imap-btn" style="width:100%; padding:12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px; margin-bottom:12px; color:white;">
                <span style="font-size:20px;">‚úâÔ∏è</span>
                <div style="text-align:left; flex:1;">
                  <div style="font-weight:600;">Other (IMAP)</div>
                  <div style="font-size:11px; opacity:0.6;">Web.de, GMX, Yahoo, T-Online, etc.</div>
                </div>
                <span style="opacity:0.4;">‚Üí</span>
              </button>
              
              <div style="padding:10px; background:rgba(59,130,246,0.15); border-radius:6px; border:1px solid rgba(59,130,246,0.2);">
                <div style="display:flex; align-items:flex-start; gap:6px;">
                  <span>üîí</span>
                  <div style="font-size:11px; opacity:0.8; line-height:1.4; color:white;">Your emails are never rendered with scripts or tracking. All content is sanitized locally.</div>
                </div>
              </div>
            </div>
            
            <!-- IMAP Credentials Step -->
            <div id="mg-wizard-imap" style="display:none; padding:16px;">
              <button id="mg-imap-back" style="background:none; border:none; color:#60a5fa; font-size:12px; cursor:pointer; padding:0; margin-bottom:10px; text-align:left;">‚Üê Back</button>
              
              <select id="mg-imap-preset" style="width:100%; padding:10px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:6px; color:white; font-size:13px; margin-bottom:10px;">
                <option value="">Select a preset...</option>
                <!-- Options populated dynamically -->
              </select>
              
              <input id="mg-imap-email" type="email" placeholder="Email Address *" style="width:100%; padding:10px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:6px; color:white; font-size:13px; margin-bottom:8px; box-sizing:border-box;" />
              
              <div style="display:grid; grid-template-columns:2fr 1fr; gap:8px; margin-bottom:8px;">
                <input id="mg-imap-host" type="text" placeholder="IMAP Server *" style="padding:10px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:6px; color:white; font-size:13px;" />
                <input id="mg-imap-port" type="number" placeholder="Port" value="993" style="padding:10px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:6px; color:white; font-size:13px;" />
              </div>
              
              <input id="mg-imap-username" type="text" placeholder="Username *" style="width:100%; padding:10px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:6px; color:white; font-size:13px; margin-bottom:8px; box-sizing:border-box;" />
              
              <input id="mg-imap-password" type="password" placeholder="Password / App Password *" style="width:100%; padding:10px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:6px; color:white; font-size:13px; margin-bottom:12px; box-sizing:border-box;" />
              
              <button id="mg-imap-connect" style="width:100%; padding:12px; background:linear-gradient(135deg, #3b82f6, #8b5cf6); border:none; border-radius:6px; color:white; font-weight:600; cursor:pointer;">Connect Email Account</button>
              
              <div style="font-size:11px; opacity:0.6; line-height:1.4; padding:8px; background:rgba(59,130,246,0.1); border-radius:4px; margin-top:10px; color:white;">
                üîí <strong>Tip:</strong> For accounts with 2FA, use an App Password.
              </div>
            </div>
            
            <!-- Connecting Step -->
            <div id="mg-wizard-connecting" style="display:none; text-align:center; padding:30px;">
              <div style="width:40px; height:40px; border:3px solid rgba(59,130,246,0.3); border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 16px;"></div>
              <div style="font-weight:600; margin-bottom:6px; color:white;">Connecting...</div>
              <div style="font-size:12px; opacity:0.6; color:white;">Please wait...</div>
              <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            </div>
          </div>
        </div>
        
        <div id="mg-hint" class="mg-hint">
          <span class="mg-hint-icon">‚úâÔ∏è</span>
          Compose verified WRGuard-stamped emails with built-in automation.
        </div>
        <div class="mg-fields">
          <div class="mg-row">
            <label class="mg-label">To:</label>
            <input type="email" id="mg-to" class="mg-input" placeholder="Enter recipient email address" />
          </div>
          <div class="mg-row">
            <label class="mg-label">Subject:</label>
            <input type="text" id="mg-subject" class="mg-input" placeholder="Enter email subject line" />
          </div>
          <textarea id="mg-body" class="mg-body" placeholder="Write your email message here...&#10;&#10;Your message will be protected with WRGuard verification and encryption."></textarea>
          <div class="mg-attach-row">
            <span class="mg-attach-label">
              <span>üìé</span> Attachments
              <span class="mg-attach-note">(WR Stamped PDFs only)</span>
            </span>
            <input id="mg-file" type="file" accept=".pdf" multiple style="display:none" />
            <button id="mg-add-pdf" class="mg-add-btn">+ Add PDF</button>
          </div>
          <div id="mg-attachments" class="mg-attachments"></div>
        </div>
        <div class="mg-footer">
          <button id="mg-discard" class="mg-discard">Discard draft</button>
          <button id="mg-send" class="mg-send" disabled>Send <span>‚Üí</span></button>
        </div>
      </div>
    </div>
    <!-- All scripting moved to popup.js to satisfy extension CSP -->
    <!-- Cache bust: v2025.01.29 -->
    <script src="popup.js?v=20250129-006"></script>
  </body>
  </html>


