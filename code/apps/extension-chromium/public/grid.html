<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AI Grid Display</title>
  <style>
    :root{
      --text:#e5e7eb;
      --surface: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.14);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text); 
      height: 100vh; 
      overflow: hidden;
    }
    
    .grid-container { 
      width: 100vw; 
      height: 100vh; 
      display: grid; 
      gap: 4px; 
      padding: 4px;
    }
    
    .grid-slot {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .slot-header {
      background: var(--surface);
      padding: 8px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    
    .slot-title {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      width: 180px;
      font-weight: bold;
    }
    
    .slot-agent {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 2px;
      border-radius: 3px;
      font-size: 10px;
    }
    
    .slot-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      opacity: 0.8;
      text-align: center;
      padding: 20px;
    }
    
    .save-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #4CAF50;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .save-button:hover {
      background: #45a049;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #4CAF50;
      color: white;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1001;
      display: none;
      opacity: 0;
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="grid-container" class="grid-container">
    <!-- Grid slots will be generated by JavaScript -->
  </div>
  
  <button id="save-grid-btn" class="save-button">💾 Save Grid</button>
  
  <div id="notification" class="notification">
    ✅ Grid saved to session!
  </div>

  <script>
    console.log('🔬 RESEARCH-BASED GRID: Starting proper implementation');
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const layout = urlParams.get('layout');
    const sessionId = urlParams.get('sessionId');
    
    console.log('🔬 GRID: Layout:', layout, 'SessionId:', sessionId);
    
    // Grid layout configurations
    const layouts = {
      '2-slot': { slots: 2, columns: '2fr 1fr', rows: 'auto' },
      '3-slot': { slots: 3, columns: '2fr 1fr 1fr', rows: 'auto' },
      '4-slot': { slots: 4, columns: '1fr 1fr', rows: '1fr 1fr' },
      '5-slot': { slots: 5, columns: '2fr 1fr 1fr', rows: '1fr 1fr' },
      '6-slot': { slots: 6, columns: '1fr 1fr 1fr', rows: '1fr 1fr' },
      '7-slot': { slots: 7, columns: '2fr 1fr 1fr', rows: '1fr 1fr' },
      '8-slot': { slots: 8, columns: 'repeat(4, 1fr)', rows: '1fr 1fr' },
      '9-slot': { slots: 9, columns: 'repeat(3, 1fr)', rows: 'repeat(3, 1fr)' },
      '10-slot': { slots: 10, columns: 'repeat(5, 1fr)', rows: '1fr 1fr' }
    };
    
    function initializeGrid() {
      if (!layout || !sessionId || !layouts[layout]) {
        console.error('🔬 GRID: Invalid parameters');
        return;
      }
      
      const config = layouts[layout];
      const container = document.getElementById('grid-container');
      
      // Set grid layout
      container.style.gridTemplateColumns = config.columns;
      if (config.rows !== 'auto') {
        container.style.gridTemplateRows = config.rows;
      }
      
      // Generate slots
      for (let i = 1; i <= config.slots; i++) {
        const slotNum = i + 5; // Start from #6
        const slot = document.createElement('div');
        slot.className = 'grid-slot';
        slot.setAttribute('data-slot-id', slotNum);
        
        // Special styling for some layouts
        if ((layout === '5-slot' || layout === '7-slot') && i === 1) {
          slot.style.gridRow = 'span 2';
        }
        
        slot.innerHTML = `
          <div class="slot-header">
            <input type="text" class="slot-title" value="Display Port ${slotNum}" placeholder="Enter custom title...">
            <select class="slot-agent">
              <option value="">Select Agent</option>
              <option value="agent1">Agent 1</option>
              <option value="agent2">Agent 2</option>
              <option value="agent3">Agent 3</option>
              <option value="agent4">Agent 4</option>
              <option value="agent5">Agent 5</option>
              <option value="agent6">Agent 6</option>
              <option value="agent7">Agent 7</option>
              <option value="agent8">Agent 8</option>
              <option value="agent9">Agent 9</option>
              <option value="agent10">Agent 10</option>
            </select>
          </div>
          <div class="slot-content">
            <div>Display Port ${slotNum}<br><small>AI Output Area</small></div>
          </div>
        `;
        
        container.appendChild(slot);
      }
      
      console.log('🔬 GRID: Generated', config.slots, 'slots for', layout);
      
      // Set page title
      document.title = `AI Grid - ${layout.toUpperCase()}`;
      
      // Load existing configuration
      loadGridConfiguration();
    }
    
    function saveGridConfiguration() {
      console.log('🔬 SAVE: Starting save process...');
      
      const config = {
        layout: layout,
        sessionId: sessionId,
        timestamp: new Date().toISOString(),
        slots: {}
      };
      
      // Collect slot data
      const slots = document.querySelectorAll('[data-slot-id]');
      console.log('🔬 SAVE: Found', slots.length, 'slots');
      
      slots.forEach((slot, index) => {
        const slotId = slot.getAttribute('data-slot-id');
        const titleInput = slot.querySelector('.slot-title');
        const agentSelect = slot.querySelector('.slot-agent');
        
        config.slots[slotId] = {
          title: titleInput ? titleInput.value : '',
          agent: agentSelect ? agentSelect.value : ''
        };
        
        console.log('🔬 SAVE: Slot', slotId, ':', titleInput?.value, '/', agentSelect?.value);
      });
      
      console.log('🔬 SAVE: Final config:', config);
      
      // Send to service worker using proper Chrome extension API
      chrome.runtime.sendMessage({
        type: 'SAVE_GRID_CONFIG',
        data: config
      }, (response) => {
        console.log('🔬 SAVE: Service worker response:', response);
        
        if (chrome.runtime.lastError) {
          console.error('🔬 SAVE: Runtime error:', chrome.runtime.lastError);
          showNotification('❌ Save failed: ' + chrome.runtime.lastError.message, 'error');
        } else if (response && response.success) {
          console.log('🔬 SAVE: Success!');
          showNotification('✅ Grid saved to session!', 'success');
        } else {
          console.error('🔬 SAVE: Failed:', response);
          showNotification('❌ Save failed: ' + (response?.error || 'Unknown error'), 'error');
        }
      });
    }
    
    function loadGridConfiguration() {
      console.log('🔬 LOAD: Loading configuration...');
      
      chrome.runtime.sendMessage({
        type: 'LOAD_GRID_CONFIG',
        sessionId: sessionId,
        layout: layout
      }, (response) => {
        if (response && response.success && response.config) {
          console.log('🔬 LOAD: Applying config:', response.config);
          applyConfiguration(response.config);
        } else {
          console.log('🔬 LOAD: No saved config found');
        }
      });
    }
    
    function applyConfiguration(config) {
      if (!config.slots) return;
      
      Object.keys(config.slots).forEach(slotId => {
        const slotData = config.slots[slotId];
        const slot = document.querySelector(`[data-slot-id="${slotId}"]`);
        
        if (slot) {
          const titleInput = slot.querySelector('.slot-title');
          const agentSelect = slot.querySelector('.slot-agent');
          
          if (titleInput && slotData.title) titleInput.value = slotData.title;
          if (agentSelect && slotData.agent) agentSelect.value = slotData.agent;
        }
      });
      
      console.log('🔬 LOAD: Configuration applied');
    }
    
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.innerHTML = message;
      notification.style.background = type === 'error' ? '#f44336' : '#4CAF50';
      notification.style.display = 'block';
      notification.style.opacity = '1';
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 300);
      }, 3000);
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🔬 GRID: DOM ready, initializing...');
      initializeGrid();
      
      // Attach save button handler
      document.getElementById('save-grid-btn').addEventListener('click', saveGridConfiguration);
    });
    
    // Also initialize immediately if already loaded
    if (document.readyState === 'loading') {
      // DOMContentLoaded will handle it
    } else {
      initializeGrid();
      document.getElementById('save-grid-btn').addEventListener('click', saveGridConfiguration);
    }
  </script>
</body>
</html>
