import { useState, useEffect, useRef } from 'react';

interface PostgresConnectionConfig {
  postgres?: {
    enabled: boolean;  // Is PostgreSQL connected and available?
    config?: {
      host: string;
      port: number;
      database: string;
      user: string;
      password: string;
      ssl: boolean;
      schema: string;
    };
  };
}

interface BackendSwitcherProps {
  theme?: 'default' | 'dark' | 'professional';
}

export function BackendSwitcher({ theme = 'default' }: BackendSwitcherProps) {
  const [config, setConfig] = useState<PostgresConnectionConfig>({
    postgres: {
      enabled: false,
      config: {
        host: '127.0.0.1',
        port: 5432,
        database: 'postgres',
        user: 'postgres',
        password: 'playboy906870',
        ssl: false,
        schema: 'public',
      },
    },
  });

  const [isTesting, setIsTesting] = useState(false);
  const [isSyncing, setIsSyncing] = useState(false);
  const [connectionTested, setConnectionTested] = useState(false);
  const [notification, setNotification] = useState<{ message: string; type: 'success' | 'error' | 'info' } | null>(null);
  const [errorLog, setErrorLog] = useState<string>('');
  const [wsConnected, setWsConnected] = useState<boolean>(false);
  const [diagnosticResults, setDiagnosticResults] = useState<{
    electronRunning: boolean;
    websocketServerListening: boolean;
    websocketConnection: boolean;
    pingPongTest: boolean;
    messageFlowTest: boolean;
    errors: string[];
    details: any;
  } | null>(null);
  const [showDiagnostics, setShowDiagnostics] = useState(false);
  const [electronLogs, setElectronLogs] = useState<string[]>([]);
  const [isExpanded, setIsExpanded] = useState(false);
  const [showAdvancedDiagnostics, setShowAdvancedDiagnostics] = useState(false);
  const [connectionSuccess, setConnectionSuccess] = useState(false);
  const [activeTab, setActiveTab] = useState<'localdb' | 'vectordb' | 'llm' | 'automation'>('localdb');
  const testTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const diagnosticTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);

  // Check WebSocket connection status on mount and periodically
  useEffect(() => {
    const checkWsStatus = () => {
      chrome.runtime.sendMessage({ type: 'GET_STATUS' }, (response) => {
        if (response?.data) {
          setWsConnected(response.data.isConnected || false);
        }
      });
    };
    
    // Check immediately
    checkWsStatus();
    
    // Check every 2 seconds
    const interval = setInterval(checkWsStatus, 2000);
    
    return () => clearInterval(interval);
  }, []);

  // Load config from storage on mount and migrate old values
  useEffect(() => {
    chrome.storage.local.get(['backendConfig'], (result) => {
      if (result.backendConfig) {
        const loadedConfig: any = result.backendConfig;
        let needsUpdate = false;
        let updatedConfig: PostgresConnectionConfig;
        
        // Migrate old format (with active field) to new format (hybrid)
        if ('active' in loadedConfig) {
          // Old format: migrate to new format
          updatedConfig = {
            postgres: {
              enabled: loadedConfig.active === 'postgres',
              config: loadedConfig.postgres || {
                host: '127.0.0.1',
                port: 5432,
                database: 'postgres',
                user: 'postgres',
                password: 'playboy906870',
                ssl: false,
                schema: 'public',
              },
            },
          };
          needsUpdate = true;
        } else {
          // New format: use as-is but ensure structure
          updatedConfig = {
            postgres: {
              enabled: loadedConfig.postgres?.enabled || false,
              config: loadedConfig.postgres?.config || {
                host: '127.0.0.1',
                port: 5432,
                database: 'postgres',
                user: 'postgres',
                password: 'playboy906870',
                ssl: false,
                schema: 'public',
              },
            },
          };
        }
        
        // Migrate old "orchestrator" values to "postgres" and ensure SSL is false for localhost
        if (updatedConfig.postgres?.config) {
          const updatedPostgres = { ...updatedConfig.postgres.config };
          
          // Migrate database name
          if (updatedPostgres.database === 'orchestrator') {
            updatedPostgres.database = 'postgres';
            needsUpdate = true;
          }
          
          // Migrate user name
          if (updatedPostgres.user === 'orchestrator') {
            updatedPostgres.user = 'postgres';
            needsUpdate = true;
          }
          
          // Ensure SSL is false for localhost connections (default for local development)
          if (updatedPostgres.host === '127.0.0.1' || updatedPostgres.host === 'localhost') {
            if (updatedPostgres.ssl !== false) {
              updatedPostgres.ssl = false;
              needsUpdate = true;
            }
          }
          
          if (needsUpdate) {
            const updatedConfig = {
              ...loadedConfig,
              postgres: updatedPostgres
            };
            setConfig(updatedConfig);
            chrome.storage.local.set({ backendConfig: updatedConfig });
            // Auto-expand if PostgreSQL is active
            if (updatedConfig.active === 'postgres') {
              setIsExpanded(true);
            }
          } else {
            setConfig(loadedConfig);
            // Auto-expand if PostgreSQL is active
            if (loadedConfig.active === 'postgres') {
              setIsExpanded(true);
            }
          }
        } else {
          setConfig(loadedConfig);
          // Auto-expand if PostgreSQL is active
          if (loadedConfig.active === 'postgres') {
            setIsExpanded(true);
          }
        }
      }
    });
  }, []);

  // Listen for WebSocket responses and status updates
  useEffect(() => {
    const handleMessage = (message: any) => {
      console.log('[BackendSwitcher] Received message:', message.type, message);
      
      // Update WebSocket connection status
      if (message.type === 'STATUS_UPDATE') {
        console.log('[BackendSwitcher] STATUS_UPDATE:', message.data);
        setWsConnected(message.data?.isConnected || false);
      }
      
      if (message.type === 'pong') {
        // Handle pong response for ping test
        console.log('[BackendSwitcher] ===== PONG RECEIVED =====');
        setDiagnosticResults(prev => {
          if (prev) {
            console.log('[BackendSwitcher] Updating pingPongTest to true');
            return {
              ...prev,
              pingPongTest: true,
              details: {
                ...prev.details,
                pingPongTest: { status: 'success', received: true }
              }
            };
          }
          return null;
        });
      } else if (message.type === 'ELECTRON_LOG') {
        // Display Electron logs in browser console and UI for debugging
        const logMessage = message.data?.message || '';
        const logData = message.data?.rawMessage || message.data?.parsedMessage || '';
        const fullLog = `${new Date().toLocaleTimeString()} - ${logMessage}${logData ? '\n' + JSON.stringify(logData, null, 2) : ''}`;
        console.log('[BackendSwitcher] üìã Electron Log:', logMessage, logData);
        setElectronLogs(prev => [...prev.slice(-49), fullLog]); // Keep last 50 logs
      }
    };

    chrome.runtime.onMessage.addListener(handleMessage);
    return () => {
      chrome.runtime.onMessage.removeListener(handleMessage);
    };
  }, [config]);

  const showNotification = (message: string, type: 'success' | 'error' | 'info') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 5000);
  };

  // Removed sendWebSocketMessage - now using HTTP API directly

  // Removed handleBackendChange - Chrome Storage is always primary

  const runDiagnostics = async () => {
    if (!config.postgres) {
      console.error('[BackendSwitcher] No postgres config available');
      return;
    }

    setIsTesting(true);
    setConnectionTested(false);
    setErrorLog('');
    setShowDiagnostics(true);
    setElectronLogs([]); // Clear previous logs
    
    const initialResults = {
      electronRunning: false,
      websocketServerListening: false,
      websocketConnection: false,
      pingPongTest: false,
      messageFlowTest: false,
      errors: [] as string[],
      details: {} as any
    };
    
    setDiagnosticResults(initialResults);
    const startTime = Date.now();

    // Step 1: Check WebSocket status (proxy for Electron running)
    console.log('[Diagnostics] Step 1: Checking Electron/WebSocket status...');
    chrome.runtime.sendMessage({ type: 'CONNECT' }, () => {
      setTimeout(() => {
        chrome.runtime.sendMessage({ type: 'GET_STATUS' }, (statusResponse) => {
          const isConnected = statusResponse?.data?.isConnected || false;
          
          setDiagnosticResults(prev => prev ? {
            ...prev,
            websocketConnection: isConnected,
            electronRunning: isConnected,
            websocketServerListening: isConnected,
            details: {
              ...prev.details,
              statusCheck: {
                isConnected,
                readyState: statusResponse?.data?.readyState
              }
            }
          } : null);

          if (!isConnected) {
            setDiagnosticResults(prev => prev ? {
              ...prev,
              errors: [...prev.errors, 'WebSocket not connected - Electron app may not be running']
            } : null);
            setIsTesting(false);
            return;
          }

          // Step 2: Test ping/pong
          console.log('[Diagnostics] Step 2: Testing ping/pong...');
          chrome.runtime.sendMessage({ type: 'DB_WEBSOCKET_MESSAGE', wsType: 'ping', data: {} }, (pingResponse) => {
            // Wait for pong response (handled by message listener)
            setTimeout(() => {
              // Step 3: Test DB_TEST_CONNECTION message flow
              console.log('[Diagnostics] Step 3: Testing DB_TEST_CONNECTION message flow...');
              const testMessage = {
                type: 'DB_WEBSOCKET_MESSAGE',
                wsType: 'DB_TEST_CONNECTION',
                data: { config: config.postgres }
              };
              console.log('[Diagnostics] ===== SENDING MESSAGE TO BACKGROUND =====');
              console.log('[Diagnostics] Message:', JSON.stringify(testMessage, null, 2));

              diagnosticTimeoutRef.current = setTimeout(() => {
                console.error('[Diagnostics] DB_TEST_CONNECTION timeout - no response received');
                setDiagnosticResults(prev => prev ? {
                  ...prev,
                  messageFlowTest: false,
                  errors: [...prev.errors, 'DB_TEST_CONNECTION message timeout - Electron not responding. Check Electron console for errors.'],
                  details: {
                    ...prev.details,
                    messageFlowTest: {
                      status: 'timeout',
                      duration: Date.now() - startTime,
                      note: 'Check Electron console for: [MAIN] ===== DB_TEST_CONNECTION HANDLER STARTED ====='
                    }
                  }
                } : null);
                setIsTesting(false);
              }, 10000);

              chrome.runtime.sendMessage(testMessage, (response) => {
                if (chrome.runtime.lastError || !response?.success) {
                  if (diagnosticTimeoutRef.current) clearTimeout(diagnosticTimeoutRef.current);
                  setDiagnosticResults(prev => prev ? {
                    ...prev,
                    messageFlowTest: false,
                    errors: [...prev.errors, chrome.runtime.lastError?.message || response?.error || 'Failed to send message']
                  } : null);
                  setIsTesting(false);
                } else {
                  // Message sent, wait for DB_TEST_CONNECTION_RESULT
                  // This will be handled by the message listener
                }
              });
            }, 1000);
          });
        });
      }, 1000);
    });
  };

  const handleTestConnection = async () => {
    if (!config.postgres) {
      showNotification('Please configure PostgreSQL settings first', 'error');
      return;
    }

    setIsTesting(true);
    setConnectionTested(false);
    setErrorLog('');
    setShowDiagnostics(false);
    setShowAdvancedDiagnostics(false);
    setConnectionSuccess(false);

    try {
      console.log('[BackendSwitcher] Testing PostgreSQL connection via HTTP API');
      const response = await fetch('http://127.0.0.1:51248/api/db/test-connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config.postgres),
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('[BackendSwitcher] Connection test result:', result);

      if (result.ok) {
        console.log('[BackendSwitcher] Connection test SUCCESS');
        setErrorLog('');
        setShowDiagnostics(false);
        setShowAdvancedDiagnostics(false);
        setConnectionSuccess(true);
        setConnectionTested(true);

        // Enable PostgreSQL on successful connection
        const newConfig: PostgresConnectionConfig = {
          ...config,
          postgres: {
            enabled: true,
            config: config.postgres?.config,
          },
        };
        setConfig(newConfig);
        chrome.storage.local.set({ backendConfig: newConfig }, () => {
          showNotification('PostgreSQL connected! Enhanced features are now available.', 'success');
        });
      } else {
        console.error('[BackendSwitcher] Connection test FAILED:', result);
        const errorDetails = {
          message: result.message || 'Connection failed',
          details: result.details || {},
          timestamp: new Date().toISOString(),
          config: {
            host: config.postgres?.config?.host,
            port: config.postgres?.config?.port,
            database: config.postgres?.config?.database,
            user: config.postgres?.config?.user,
            schema: config.postgres?.config?.schema,
            ssl: config.postgres?.config?.ssl,
          }
        };
        const errorLogText = JSON.stringify(errorDetails, null, 2);
        setErrorLog(errorLogText);
        setShowDiagnostics(true);
        setShowAdvancedDiagnostics(true);
        showNotification(`Connection failed: ${result.message}`, 'error');
      }
    } catch (error: any) {
      console.error('[BackendSwitcher] Connection test error:', error);
      const errorDetails = {
        message: error.message || 'Connection test failed',
        details: {
          error: error.toString(),
          type: error.name,
        },
        timestamp: new Date().toISOString(),
        config: {
          host: config.postgres?.config?.host,
          port: config.postgres?.config?.port,
          database: config.postgres?.config?.database,
          user: config.postgres?.config?.user,
          schema: config.postgres?.config?.schema,
          ssl: config.postgres?.config?.ssl,
        }
      };
      const errorLogText = JSON.stringify(errorDetails, null, 2);
      setErrorLog(errorLogText);
      setShowDiagnostics(true);
      setShowAdvancedDiagnostics(true);
      showNotification(`Connection failed: ${error.message || 'Network error'}`, 'error');
    } finally {
      setIsTesting(false);
    }
  };

  // Removed handleSync - not needed with hybrid approach (data routes automatically)


  const updatePostgresConfig = (field: 'host' | 'port' | 'database' | 'user' | 'password' | 'ssl' | 'schema', value: any) => {
    if (!config.postgres?.config) return;
    const newConfig: PostgresConnectionConfig = {
      ...config,
      postgres: {
        ...config.postgres,
        config: {
          ...config.postgres.config,
          [field]: value,
        },
      },
    };
    setConfig(newConfig);
    chrome.storage.local.set({ backendConfig: newConfig });
  };

  const bgColor = theme === 'default' ? 'rgba(118,75,162,0.5)' : theme === 'dark' ? 'rgba(255,255,255,0.12)' : 'rgba(15,23,42,0.08)';
  const borderColor = theme === 'default' ? 'rgba(255,255,255,0.15)' : theme === 'dark' ? 'rgba(255,255,255,0.2)' : 'rgba(15,23,42,0.3)';
  const textColor = theme === 'default' ? '#fff' : theme === 'dark' ? '#fff' : '#0f172a';

  return (
    <>
    <div style={{
      background: bgColor,
      padding: '12px',
      borderRadius: '10px',
      marginBottom: '16px',
      border: `1px solid ${borderColor}`,
    }}>
      {/* Collapsible Header */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '12px',
        cursor: 'pointer',
      }} onClick={() => setIsExpanded(!isExpanded)}>
        <h3 style={{
          margin: 0,
          fontSize: '13px',
          fontWeight: '700',
          textTransform: 'uppercase',
          letterSpacing: '0.5px',
          opacity: 0.95,
          color: textColor,
        }}>
          ‚öôÔ∏è Backend Configuration
        </h3>
        <span style={{
          fontSize: '12px',
          color: textColor,
          opacity: 0.7,
          transition: 'transform 0.2s',
          transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)',
        }}>
          ‚ñº
        </span>
      </div>

      {/* Collapsible Content */}
      {isExpanded && (
        <>
          {/* Tabs */}
          <div style={{
            display: 'flex',
            gap: '4px',
            marginBottom: '16px',
            borderBottom: `1px solid ${borderColor}`,
            paddingBottom: '8px',
          }}>
            <button
              onClick={() => setActiveTab('localdb')}
              style={{
                flex: 1,
                padding: '8px 12px',
                background: activeTab === 'localdb' ? 'rgba(59, 130, 246, 0.2)' : 'transparent',
                border: activeTab === 'localdb' ? `1px solid rgba(59, 130, 246, 0.4)` : `1px solid ${borderColor}`,
                borderRadius: '4px',
                color: textColor,
                fontSize: '11px',
                fontWeight: activeTab === 'localdb' ? '600' : '400',
                cursor: 'pointer',
                transition: 'all 0.2s',
              }}
            >
              Local DB {config.postgres?.enabled && '‚úì'}
            </button>
            <button
              onClick={() => setActiveTab('vectordb')}
              disabled
              style={{
                flex: 1,
                padding: '8px 12px',
                background: 'transparent',
                border: `1px solid ${borderColor}`,
                borderRadius: '4px',
                color: textColor,
                fontSize: '11px',
                fontWeight: '400',
                cursor: 'not-allowed',
                opacity: 0.5,
              }}
            >
              Vector DB
            </button>
            <button
              onClick={() => setActiveTab('llm')}
              disabled
              style={{
                flex: 1,
                padding: '8px 12px',
                background: 'transparent',
                border: `1px solid ${borderColor}`,
                borderRadius: '4px',
                color: textColor,
                fontSize: '11px',
                fontWeight: '400',
                cursor: 'not-allowed',
                opacity: 0.5,
              }}
            >
              LLM
            </button>
            <button
              onClick={() => setActiveTab('automation')}
              disabled
              style={{
                flex: 1,
                padding: '8px 12px',
                background: 'transparent',
                border: `1px solid ${borderColor}`,
                borderRadius: '4px',
                color: textColor,
                fontSize: '11px',
                fontWeight: '400',
                cursor: 'not-allowed',
                opacity: 0.5,
              }}
            >
              Automation
            </button>
          </div>

          {/* Local DB Tab Content */}
          {activeTab === 'localdb' && (
            <>
              {/* Status */}
              {config.postgres?.enabled && (
                <div style={{
                  marginBottom: '12px',
                  padding: '8px 10px',
                  background: 'rgba(34, 197, 94, 0.12)',
                  border: '1px solid rgba(34, 197, 94, 0.3)',
                  borderRadius: '4px',
                  fontSize: '10px',
                  color: '#22c55e',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                }}>
                  <span style={{ fontSize: '12px' }}>‚úì</span>
                  <span>Connected</span>
                </div>
              )}

              {/* PostgreSQL Form */}
          {config.postgres?.config && (
        <div style={{ marginBottom: '16px' }}>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px' }}>
            <div>
              <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: textColor, opacity: 0.9 }}>Host</label>
              <input
                type="text"
                value={config.postgres.config?.host || ''}
                onChange={(e) => updatePostgresConfig('host', e.target.value)}
                style={{
                  width: '100%',
                  padding: '6px',
                  background: 'rgba(0,0,0,0.2)',
                  border: `1px solid ${borderColor}`,
                  color: textColor,
                  borderRadius: '4px',
                  fontSize: '11px',
                }}
              />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: textColor, opacity: 0.9 }}>Port</label>
              <input
                type="number"
                value={config.postgres.config?.port || 5432}
                onChange={(e) => updatePostgresConfig('port', parseInt(e.target.value) || 5432)}
                style={{
                  width: '100%',
                  padding: '6px',
                  background: 'rgba(0,0,0,0.2)',
                  border: `1px solid ${borderColor}`,
                  color: textColor,
                  borderRadius: '4px',
                  fontSize: '11px',
                }}
              />
            </div>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px' }}>
            <div>
              <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: textColor, opacity: 0.9 }}>Database</label>
              <input
                type="text"
                value={config.postgres.config?.database || ''}
                onChange={(e) => updatePostgresConfig('database', e.target.value)}
                style={{
                  width: '100%',
                  padding: '6px',
                  background: 'rgba(0,0,0,0.2)',
                  border: `1px solid ${borderColor}`,
                  color: textColor,
                  borderRadius: '4px',
                  fontSize: '11px',
                }}
              />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: textColor, opacity: 0.9 }}>User</label>
              <input
                type="text"
                value={config.postgres.config?.user || ''}
                onChange={(e) => updatePostgresConfig('user', e.target.value)}
                style={{
                  width: '100%',
                  padding: '6px',
                  background: 'rgba(0,0,0,0.2)',
                  border: `1px solid ${borderColor}`,
                  color: textColor,
                  borderRadius: '4px',
                  fontSize: '11px',
                }}
              />
            </div>
          </div>
          <div style={{ marginBottom: '8px' }}>
            <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: textColor, opacity: 0.9 }}>Password</label>
            <input
              type="password"
              value={config.postgres.config?.password || ''}
              onChange={(e) => updatePostgresConfig('password', e.target.value)}
              style={{
                width: '100%',
                padding: '6px',
                background: 'rgba(0,0,0,0.2)',
                border: `1px solid ${borderColor}`,
                color: textColor,
                borderRadius: '4px',
                fontSize: '11px',
              }}
            />
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px' }}>
            <div>
              <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: textColor, opacity: 0.9 }}>Schema</label>
              <input
                type="text"
                value={config.postgres.config?.schema || ''}
                onChange={(e) => updatePostgresConfig('schema', e.target.value)}
                style={{
                  width: '100%',
                  padding: '6px',
                  background: 'rgba(0,0,0,0.2)',
                  border: `1px solid ${borderColor}`,
                  color: textColor,
                  borderRadius: '4px',
                  fontSize: '11px',
                }}
              />
            </div>
            <div style={{ display: 'flex', alignItems: 'flex-end' }}>
              <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '11px', color: textColor, opacity: 0.9 }}>
                <input
                  type="checkbox"
                  checked={config.postgres.config?.ssl || false}
                  onChange={(e) => updatePostgresConfig('ssl', e.target.checked)}
                  style={{ margin: 0 }}
                />
                SSL
              </label>
            </div>
          </div>
        </div>
          )}

          {/* Action Buttons */}
          <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '12px' }}>
            <button
              onClick={handleTestConnection}
              disabled={isTesting || !wsConnected}
              style={{
                flex: 1,
                minWidth: '100px',
                padding: '8px 12px',
                background: connectionSuccess ? '#22c55e' : (isTesting || !wsConnected ? 'rgba(255,255,255,0.2)' : '#2196F3'),
                border: 'none',
                color: '#fff',
                borderRadius: '6px',
                cursor: isTesting || !wsConnected ? 'not-allowed' : 'pointer',
                fontSize: '12px',
                fontWeight: '600',
                opacity: isTesting || !wsConnected ? 0.6 : 1,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '6px',
              }}
            >
              {connectionSuccess && <span style={{ marginRight: '6px' }}>‚úì</span>}
              {isTesting ? 'Connecting...' : connectionSuccess ? 'Connected' : 'Connect Local PostgreSQL'}
            </button>
          </div>
          
          {/* Connection Status */}
          {config.postgres?.enabled && (
            <div style={{
              marginBottom: '12px',
              padding: '8px',
              background: 'rgba(34, 197, 94, 0.1)',
              border: '1px solid rgba(34, 197, 94, 0.3)',
              borderRadius: '6px',
              fontSize: '11px',
              color: textColor,
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
            }}>
              <span style={{ color: '#22c55e', fontSize: '14px' }}>‚úì</span>
              <span><strong>PostgreSQL Connected</strong> - Enhanced features are available</span>
            </div>
          )}

          {/* Advanced Diagnostics Toggle - Only show when there are errors */}
          {errorLog && (
            <div style={{ marginBottom: '12px' }}>
              <button
                onClick={() => setShowAdvancedDiagnostics(!showAdvancedDiagnostics)}
                style={{
                  width: '100%',
                  padding: '8px',
                  background: 'rgba(239, 68, 68, 0.1)',
                  border: `1px solid rgba(239, 68, 68, 0.3)`,
                  borderRadius: '6px',
                  color: textColor,
                  cursor: 'pointer',
                  fontSize: '11px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '6px',
                }}
              >
                {showAdvancedDiagnostics ? '‚ñº' : '‚ñ∂'} View Diagnostics
              </button>
            </div>
          )}

          {/* Advanced Diagnostics Display - Only show when toggled and there are errors */}
          {showAdvancedDiagnostics && errorLog && (
            <div style={{
              marginTop: '12px',
              padding: '12px',
              background: 'rgba(239, 68, 68, 0.1)',
              border: `1px solid rgba(239, 68, 68, 0.3)`,
              borderRadius: '6px',
            }}>
              {/* WebSocket Connection Status */}
              <div style={{
                marginBottom: '12px',
                padding: '8px',
                background: wsConnected ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                border: `1px solid ${wsConnected ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'}`,
                borderRadius: '6px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
              }}>
                <span style={{
                  width: '8px',
                  height: '8px',
                  borderRadius: '50%',
                  background: wsConnected ? '#22c55e' : '#ef4444',
                  display: 'inline-block',
                }}></span>
                <span style={{
                  fontSize: '11px',
                  color: textColor,
                  fontWeight: '500',
                }}>
                  {wsConnected ? '‚úÖ Electron app connected' : '‚ùå Electron app not connected - Start the Electron app first'}
                </span>
              </div>

              {/* Diagnostic Results */}
              {showDiagnostics && diagnosticResults && (
                <div style={{
                  marginBottom: '12px',
                }}>
                  <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '12px',
              }}>
                <label style={{
                  fontSize: '11px',
                  fontWeight: '600',
                  color: diagnosticResults.messageFlowTest ? '#22c55e' : '#ef4444',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                }}>
                  {diagnosticResults.messageFlowTest ? '‚úÖ Diagnostic Results' : 'üî¥ Diagnostic Results'}
                </label>
                <button
                  onClick={() => {
                    const report = JSON.stringify({
                      timestamp: new Date().toISOString(),
                      ...diagnosticResults,
                      config: {
                        host: config.postgres?.config?.host,
                        port: config.postgres?.config?.port,
                        database: config.postgres?.config?.database,
                        user: config.postgres?.config?.user,
                        schema: config.postgres?.config?.schema,
                        ssl: config.postgres?.config?.ssl,
                      }
                    }, null, 2);
                    navigator.clipboard.writeText(report).then(() => {
                      showNotification('Diagnostic report copied to clipboard', 'success');
                    }).catch(() => {
                      showNotification('Failed to copy report', 'error');
                    });
                  }}
                  style={{
                    padding: '4px 8px',
                    background: diagnosticResults.messageFlowTest ? '#22c55e' : '#ef4444',
                    border: 'none',
                    color: '#fff',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '10px',
                    fontWeight: '600',
                  }}
                >
                  üìã Copy Report
                </button>
              </div>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '12px', width: '20px' }}>
                    {diagnosticResults.electronRunning ? '‚úÖ' : '‚ùå'}
                  </span>
                  <span style={{ fontSize: '11px', color: textColor }}>
                    Electron app {diagnosticResults.electronRunning ? 'running' : 'not running'}
                  </span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '12px', width: '20px' }}>
                    {diagnosticResults.websocketServerListening ? '‚úÖ' : '‚ùå'}
                  </span>
                  <span style={{ fontSize: '11px', color: textColor }}>
                    WebSocket server {diagnosticResults.websocketServerListening ? 'listening' : 'not listening'} on port 51247
                  </span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '12px', width: '20px' }}>
                    {diagnosticResults.websocketConnection ? '‚úÖ' : '‚ùå'}
                  </span>
                  <span style={{ fontSize: '11px', color: textColor }}>
                    WebSocket connection {diagnosticResults.websocketConnection ? 'established' : 'failed'}
                  </span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '12px', width: '20px' }}>
                    {diagnosticResults.pingPongTest ? '‚úÖ' : '‚è≥'}
                  </span>
                  <span style={{ fontSize: '11px', color: textColor }}>
                    Ping/Pong test {diagnosticResults.pingPongTest ? 'successful' : 'pending'}
                  </span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '12px', width: '20px' }}>
                    {diagnosticResults.messageFlowTest ? '‚úÖ' : diagnosticResults.messageFlowTest === false ? '‚ùå' : '‚è≥'}
                  </span>
                  <span style={{ fontSize: '11px', color: textColor }}>
                    Database connection test {diagnosticResults.messageFlowTest ? 'successful' : diagnosticResults.messageFlowTest === false ? 'failed' : 'in progress...'}
                  </span>
                </div>
              </div>

              {diagnosticResults.errors.length > 0 && (
                <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${borderColor}` }}>
                  <div style={{ fontSize: '11px', fontWeight: '600', color: '#ef4444', marginBottom: '8px' }}>
                    Errors:
                  </div>
                  {diagnosticResults.errors.map((error, index) => (
                    <div key={index} style={{ fontSize: '10px', color: textColor, marginBottom: '4px', paddingLeft: '12px' }}>
                      ‚Ä¢ {error}
                    </div>
                  ))}
                  {diagnosticResults.errors.some(e => e.includes('timeout')) && (
                    <div style={{ marginTop: '8px', padding: '8px', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '4px', fontSize: '10px', color: textColor }}>
                      <strong>üí° Troubleshooting:</strong><br/>
                      Check Electron console (terminal) for:<br/>
                      ‚Ä¢ <code>[MAIN] ===== RAW WEBSOCKET MESSAGE RECEIVED =====</code><br/>
                      ‚Ä¢ <code>[MAIN] ===== DB_TEST_CONNECTION HANDLER STARTED =====</code><br/>
                      If these don't appear, Electron isn't receiving the message.
                    </div>
                  )}
                </div>
              )}

              {diagnosticResults.details.messageFlowTest?.response && (
                <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${borderColor}` }}>
                  <div style={{ fontSize: '11px', fontWeight: '600', color: textColor, marginBottom: '8px' }}>
                    Database Response:
                  </div>
                  <div style={{ fontSize: '10px', color: textColor, paddingLeft: '12px' }}>
                    {diagnosticResults.details.messageFlowTest.response.message}
                  </div>
                </div>
              )}

              {/* Electron Logs Display */}
              {electronLogs.length > 0 && (
                <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${borderColor}` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                    <div style={{ fontSize: '11px', fontWeight: '600', color: textColor }}>
                      üìã Electron Logs ({electronLogs.length})
                    </div>
                    <button
                      onClick={() => {
                        const logsText = electronLogs.join('\n\n');
                        navigator.clipboard.writeText(logsText).then(() => {
                          showNotification('Electron logs copied to clipboard', 'success');
                        }).catch(() => {
                          showNotification('Failed to copy logs', 'error');
                        });
                      }}
                      style={{
                        padding: '4px 8px',
                        background: '#3b82f6',
                        border: 'none',
                        color: '#fff',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontSize: '10px',
                        fontWeight: '600',
                      }}
                    >
                      üìã Copy Logs
                    </button>
                  </div>
                  <div style={{
                    maxHeight: '200px',
                    overflowY: 'auto',
                    padding: '8px',
                    background: 'rgba(0, 0, 0, 0.2)',
                    border: `1px solid ${borderColor}`,
                    borderRadius: '4px',
                    fontSize: '10px',
                    fontFamily: 'monospace',
                    color: textColor,
                    whiteSpace: 'pre-wrap',
                    wordBreak: 'break-word',
                  }}>
                    {electronLogs.map((log, index) => (
                      <div key={index} style={{ marginBottom: index < electronLogs.length - 1 ? '8px' : '0', paddingBottom: index < electronLogs.length - 1 ? '8px' : '0', borderBottom: index < electronLogs.length - 1 ? `1px solid ${borderColor}` : 'none' }}>
                        {log}
                      </div>
                    ))}
                  </div>
                </div>
              )}
                </div>
              )}

              {/* Error Log Display */}
              {errorLog && (
                <div style={{
                  marginTop: '12px',
                  padding: '12px',
                  background: 'rgba(239, 68, 68, 0.1)',
                  border: `1px solid rgba(239, 68, 68, 0.3)`,
                  borderRadius: '6px',
                }}>
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '8px',
                  }}>
                    <label style={{
                      fontSize: '11px',
                      fontWeight: '600',
                      color: '#ef4444',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                    }}>
                      üî¥ Detailed Error Log
                    </label>
                    <button
                      onClick={() => {
                        navigator.clipboard.writeText(errorLog).then(() => {
                          showNotification('Error log copied to clipboard', 'success');
                        }).catch(() => {
                          showNotification('Failed to copy error log', 'error');
                        });
                      }}
                      style={{
                        padding: '4px 8px',
                        background: '#ef4444',
                        border: 'none',
                        color: '#fff',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontSize: '10px',
                        fontWeight: '600',
                      }}
                    >
                      üìã Copy Log
                    </button>
                  </div>
                  <pre style={{
                    margin: 0,
                    padding: '8px',
                    background: 'rgba(0, 0, 0, 0.2)',
                    border: `1px solid ${borderColor}`,
                    borderRadius: '4px',
                    fontSize: '10px',
                    color: textColor,
                    overflow: 'auto',
                    maxHeight: '200px',
                    whiteSpace: 'pre-wrap',
                    wordBreak: 'break-word',
                    fontFamily: 'monospace',
                  }}>
                    {errorLog}
                  </pre>
                </div>
              )}
            </div>
          )}
        </>
      )}
    </div>

    {/* Notification Toast */}
    {notification && (
      <div style={{
        position: 'fixed',
        bottom: '20px',
        right: '20px',
        padding: '12px 16px',
        background: notification.type === 'success' ? '#22c55e' : notification.type === 'error' ? '#ef4444' : '#3b82f6',
        color: '#fff',
        borderRadius: '8px',
        fontSize: '12px',
        boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
        zIndex: 10000,
        maxWidth: '300px',
      }}>
        {notification.message}
      </div>
    )}
    </>
  );
}

